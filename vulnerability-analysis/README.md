# NVIDIA AI Blueprint: Vulnerability Analysis for Container Security
This Helm chart has been built upon the [NVIDIA Vulnerability Analysis for Container Security Blueprint](https://github.com/NVIDIA-AI-Blueprints/vulnerability-analysis) and deploys it, along with additional services on HPE Private Cloud AI (PCAI) environments.

It is reusing code developed internally at HPE, and available in the [blueprint-vulnerability-analysis internal repo](https://github.hpe.com/hpe/blueprint-vulnerability-analysis/tree/develop). 
This internal repo details its improvements over the original NVIDIA Blueprint, mainly the addition of an Ezwrapper application that introduces a simplified, configurable input JSON format and that manages all communication with the vulnerability analysis backend.


| Owner                       | Name                              | Email                                         |
| ----------------------------|-----------------------------------|-----------------------------------------------|
| Use Case Owner              | Tanguy Pomas                      | tanguy.pomas@hpe.com                          |
| PCAI Deployment Owner       | Tanguy Pomas                      | tanguy.pomas@hpe.com                          |


## Prerequisites

### Hardware requirementsÃ¨s

This blueprint requires **one NVIDIA GPU with CUDA support** to run, even when not self-hosting the NIMs used by this blueprint (Meta Llama 3.1 70B Instruct as LLM and NV-EmbedQA-E5-v5 as embedding model by default).


### Prepare Required API Keys
   These APIs are required by the workflow to retrieve vulnerability information from databases, perform online searches, and execute LLM queries.

  - **GitHub Security Advisory (GHSA) Database**
    - Follow [these](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens#creating-a-fine-grained-personal-access-token) instructions to create a personal access token. No repository access or permissions are required for this API.
    - This will be `GHSA_API_KEY` in the values file.
  - **National Vulnerability Database (NVD)**
    - Follow [these](https://nvd.nist.gov/developers/request-an-api-key) instructions to create an API key.
    - This will be `NVD_API_KEY` in the values file.
  - **SerpApi**
    - Go to https://serpapi.com/ and create a SerpApi account. Once signed in, navigate to Your Account > Api Key.
    - This will be `SERPAPI_API_KEY` in the values file.
  - **NVIDIA Inference Microservices (NIM)**
    - There are two possible methods to generate an API key for NIM:
      - Sign in to the [NVIDIA Build](https://build.nvidia.com/explore/discover?signin=true) portal with your email.
        - Click on any [model](https://build.nvidia.com/meta/llama-3_1-70b-instruct), then click "Get API Key", and finally click "Generate Key".
      - Sign in to the [NVIDIA NGC](https://ngc.nvidia.com/) portal with your email.
        - Select your organization from the dropdown menu after logging in. You must select an organization which has NVIDIA AI Enterprise (NVAIE) enabled.
        - Click on your account in the top right, select "Setup" from the dropdown.
        - Click the "Generate Personal Key" option and then the "+ Generate Personal Key" button to create your API key.
    - This will be `NVIDIA_API_KEY` in the values file.

## Import Framework

1. Log in to the HPE AI Essentials web interface.

2. Click the **Tools & Frameworks** icon on the left navigation bar.

3. Click **+ Import Framework**.

- **Framework Name**: of your choice, for example `NVIDIA Vulnerability Analysis for Container Security`.
- **Description**: of your choice, for example `This blueprint demonstrates accelerated analysis on common vulnerabilities and exposures (CVE) at an enterprise scale, reducing mitigation from days and hours to just seconds.`.
- **Category**: of your choice, for example `Analytics`.
- **Framework Icon**: Click `Select File` and select the icon you want to use, e.g. the logo file in this repo.
- **Helm Chart**: Choose the packaged `.tgz` chart file available in this folder.
- **Namespace**: where you created your secrets in, for example `vulnerability-analysis`
- **Release**: of your choice, for example `vulnerability-analysis`

4. Use your API keys to fill the following values, under the secrets section (line 82):
- **NVD_API_KEY**: copy your NVD API key
- **GHSA_API_KEY**: copy your GHSA API key
- **NVIDIA_API_KEY**: copy your NVIDIA API key
- **SERPAPI_API_KEY**: copy your SerpApi key


## How to use

### Input Preprocessing/Formatting

1. Scan your image for CVEs (using Trivy or another scanner).
2. Generate SBOM (using Syft or another SBOM generation tool) and base64 encodes the raw SBOM file.
3. Create your input JSON file and fills in all required fields. Refer to the following for reference:

```
{
  "repos": [
    {
      "repository": {
        "url": "https://github.com/org/repo1",
        "branch": "main"
      },
      "images": [
        {
          "name": "image1",
          "tag": "tag1",
          "sbom": "<raw-base64-encoded-sbom>",
          "cves": ["CVE-1", "CVE-2"]
        },
        {
          "name": "image2",
          "tag": "tag2",
          "sbom": "<raw-base64-encoded-sbom>",
          "cves": ["CVE-1", "CVE-2", "CVE-3"]
        }
      ]
    },
    {
      "repository": {
        "url": "https://github.com/org/repo2",
        "branch": "develop"
      },
      "images": [
        {
          "name": "image3",
          "tag": "tag3",
          "sbom": "<raw-base64-encoded-sbom>",
          "cves": ["CVE-1"]
        }
      ]
    }
  ]
}
```

### Submit the analysis request

Note the application endpoint, displayed on its tile, after its deployment. It should be "https://morpheus-vulnerability-analysis.<YOUR_DOMAIN_NAME>".

To submit your analysis request, run this curl command:

```sh
curl -X POST -H "Content-Type: application/json" -d @path/to/your/formatted_input.json -o output.json <APPLICATION_ENDPOINT>/analyze
```

After a **few minutes of processing (depending on the input)**, the result of the analysis should be available in the the JSON file specified after the -o flag.


